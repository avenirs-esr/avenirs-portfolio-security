<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">avenirs-portfolio-security</a> &gt; <a href="index.source.html" class="el_package">fr.avenirsesr.portfolio.security.service</a> &gt; <span class="el_source">AuthenticationService.java</span></div><h1>AuthenticationService.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package fr.avenirsesr.portfolio.security.service;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.HashMap;
import java.util.Optional;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestClient;

import fr.avenirsesr.portfolio.security.model.OIDCAccessTokenResponse;
import fr.avenirsesr.portfolio.security.model.OIDCIntrospectResponse;
import fr.avenirsesr.portfolio.security.model.OIDCProfileResponse;
import io.jsonwebtoken.Claims;

/**
 * &lt;h1&gt;AuthenticationService&lt;/h1&gt;
 * &lt;p&gt;
 * &lt;b&gt;Description:&lt;/b&gt; Interacts with OIDC Provider to retrieve or check access token (JWT)
 * &lt;/p&gt;
 *
 * &lt;h2&gt;Version:&lt;/h2&gt;
 * 1.0.0
 *
 * &lt;h2&gt;Author:&lt;/h2&gt;
 * Arnaud Deman
 *
 * &lt;h2&gt;Since:&lt;/h2&gt;
 * 04/10/2024
 */
<span class="fc" id="L39">@Slf4j</span>
@Service
<span class="fc" id="L41">public class AuthenticationService {</span>
	
	/** Rest client to interact with OIDC provider. */
<span class="fc" id="L44">	private final RestClient restClient = RestClient.create();</span>

	/** Template to generate the OIDC authorization URL. */
	@Value(&quot;${avenirs.authentication.oidc.authorise.template.url}&quot;)
	private String oidcAuthorizeTemplate;

	/** Template to generate the Access Token URL. */
	@Value(&quot;${avenirs.authentication.oidc.token.template.url}&quot;)
	private String oidcAccessTokenTemplate;

	@Value(&quot;${avenirs.authentication.oidc.provider.introspect.url}&quot;)
	private String oidcProviderIntrospectURL;

	/** Template to generate the service URL. */
	@Value(&quot;${avenirs.authentication.service.template}&quot;)
	private String serviceTemplate;

	/** Basic authentication header for the interaction with the OIDC provider. */
	private String basicAuthenticationHeader;

	/** Profile end point. */
	@Value(&quot;${avenirs.authentication.oidc.provider.profile.url}&quot;)
	private String oidcProviderProfileURL;

	@Value(&quot;${avenirs.authentication.oidc.client.id}&quot;)
	private String clientId;

	@Value(&quot;${avenirs.authentication.oidc.client.secret}&quot;)
	private String clientSecret;

	@Autowired
	private JWTService jwtService;

	/**
	 * Generates the OIDC Authorize URL.
	 * 
	 * @param host The host associated to the OIDC provider.
	 * @param code The code provided by the OIDC provider.
	 * @return The authorize URL.
	 */
	public String generateAuthorizeURL(String host, String code) {

<span class="fc" id="L86">		String oidcAuthorizeURL = String.format(oidcAuthorizeTemplate, host, host, code);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">			String maskedCode = code == null ? &quot;null&quot; : &quot;*&quot;.repeat(code.length());</span>
<span class="fc" id="L89">			String maskedOIDCAuthorizeURL = String.format(oidcAuthorizeTemplate, host, host, maskedCode);</span>
<span class="fc" id="L90">			log.trace(&quot;generateAuthorizeURL, host: {}&quot;, host);</span>
<span class="fc" id="L91">			log.trace(&quot;generateAuthorizeURL, code: {}&quot;, maskedCode);</span>

<span class="fc" id="L93">			log.trace(&quot;generateAuthorizeURL, oidcAuthorizeURL: {}&quot;, maskedOIDCAuthorizeURL);</span>
		}
<span class="fc" id="L95">		return oidcAuthorizeURL;</span>
	}

	/**
	 * Generates the OIDC Access Token URL.
	 * 
	 * @param login    The user login.
	 * @param password The user password.
	 * @return The authorize URL.
	  */
	protected String generateAccessTokenURL(String login, String password) {
<span class="fc" id="L106">		String oidcAccessTokenURL = String.format(oidcAccessTokenTemplate, login, password);</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">		if (log.isDebugEnabled()) {</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">			String maskedPassword = password == null ? &quot;null&quot;: &quot;*&quot;.repeat(password.length());</span>
<span class="fc" id="L110">			String maskedOIDCAccessTokenURL = String.format(oidcAccessTokenTemplate, login, maskedPassword);</span>
<span class="fc" id="L111">			log.debug(&quot;generateAccessTokenURL, maskedOIDCAccessTokenURL: {}&quot;, maskedOIDCAccessTokenURL);</span>
		}
<span class="fc" id="L113">		return oidcAccessTokenURL;</span>
	}

	/**
	 * Generates the OIDC Authorize URL.
	 * 
	 * @param host The host associated to the OIDC provider.
	 * @return The service URL.
	  */
	public String generateServiceURL(String host) {

<span class="fc" id="L124">		String serviceURL = String.format(serviceTemplate, host);</span>
<span class="fc" id="L125">		log.debug(&quot;generateServiceURL, serviceURL: {}&quot;, serviceURL);</span>
<span class="fc" id="L126">		return serviceURL;</span>
	}

	/**
	 * Generates the OIDC Profile URL.
	 * 
	 * @param token The access token used to retrieve the user profile.
	 * @return The profile URL
	 */
	public String generateProfileURL(String token) {

<span class="fc" id="L137">		String profileURL = String.format(oidcProviderProfileURL, token);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">		if (log.isDebugEnabled()) {</span>
<span class="fc" id="L139">			String maskedProfileURL = String.format(oidcProviderProfileURL, token.substring(0, 4) + &quot;****&quot; + token.substring(token.length() - 4));</span>
<span class="fc" id="L140">			log.debug(&quot;generateProfileURL, maskedProfileURL: {}&quot;, maskedProfileURL);</span>
		}
<span class="fc" id="L142">		return profileURL;</span>
	}

	/**
	 * Generates the OIDC Introspect URL.
	 * 
	 * @param token The access token used to retrieve the user profile.
	 * @return The introspect URL
	 */
	public String generateIntrospectURL(String token) {

<span class="fc" id="L153">		String introspectURL = String.format(oidcProviderIntrospectURL, token);</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="fc" id="L155">			String maskedIntrospectURL = String.format(oidcProviderIntrospectURL, token.substring(0, 4) + &quot;****&quot; + token.substring(token.length() - 4));</span>
<span class="fc" id="L156">			log.trace(&quot;generateIntrospectURL, maskedIntrospectURL: {}&quot;, maskedIntrospectURL);</span>
		}

<span class="fc" id="L159">		return introspectURL;</span>
	}

	/**
	 * Gets the profile associated to an access token.
	 * 
	 * @param token The token granted to the user for which the profile has to be retrieved.
	 * @return The Profile response of the OIDC Provider.
	 */
	public OIDCProfileResponse profile(String token) {

<span class="fc" id="L170">		log.trace(&quot;profile&quot;);</span>

<span class="fc" id="L172">OIDCProfileResponse profileResponse = restClient.post()</span>
<span class="fc" id="L173">				.uri(generateProfileURL(token))</span>
<span class="fc" id="L174">				.header(&quot;Authorization&quot;, basicAuthentication())</span>
<span class="fc" id="L175">				.contentType(MediaType.APPLICATION_FORM_URLENCODED)</span>
<span class="fc" id="L176">				.accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L177">				.retrieve()</span>
<span class="fc" id="L178">				.body(OIDCProfileResponse.class);</span>

<span class="fc" id="L180">		log.debug(&quot;profile, profileResponse: {}&quot;, profileResponse);</span>

<span class="fc" id="L182">		return profileResponse;</span>
	}

	/**
	 * OIDC introspection of an access token.
	 * 
	 * @param token The access token to introspect.
	 * @return The introspect response of the OIDC Provider.
	 */
	public OIDCIntrospectResponse introspectAccessToken(String token) {

<span class="fc" id="L193">		log.debug(&quot;introspectAccessToken&quot;);</span>

<span class="fc" id="L195">		OIDCIntrospectResponse introspectResponse = restClient</span>
<span class="fc" id="L196">				.post()</span>
<span class="fc" id="L197">				.uri(generateIntrospectURL(token))</span>
<span class="fc" id="L198">				.header(&quot;Authorization&quot;, basicAuthentication())</span>
<span class="fc" id="L199">				.contentType(MediaType.APPLICATION_FORM_URLENCODED)</span>
<span class="fc" id="L200">				.accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L201">				.retrieve()</span>
<span class="fc" id="L202">				.body(OIDCIntrospectResponse.class);</span>

<span class="fc" id="L204">		log.debug(&quot;introspect, introspectResponse: {}&quot;, introspectResponse);</span>

<span class="fc" id="L206">		return introspectResponse;</span>
	}

	/**
	 * Generates an access token
	 * 
	 * @param login    The user login.
	 * @param password The user password.
	 * @return An Optional of OIDCAccessTokenResponse
	 */
	public Optional&lt;OIDCAccessTokenResponse&gt; getAccessToken(String login, String password) {
		try {

<span class="fc" id="L219">			String query = generateAccessTokenURL(login, password);</span>
<span class="fc" id="L220">			OIDCAccessTokenResponse response = restClient.post().uri(query).retrieve()</span>
<span class="fc" id="L221">					.body(OIDCAccessTokenResponse.class);</span>

<span class="pc bpc" id="L223" title="1 of 2 branches missed.">			if (response == null) {</span>
<span class="nc" id="L224">				return Optional.empty();</span>
			}

<span class="fc" id="L227">			final Optional&lt;Claims&gt; claims = this.jwtService.parseAndCheckSignature(response);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">			if (claims.isEmpty()) {</span>
<span class="nc" id="L229">				log.error(&quot;Invalid access token response: {}&quot;, response);</span>
<span class="nc" id="L230">				return Optional.empty();</span>
			}
			
<span class="fc" id="L233">			log.trace(&quot;Claims: {}&quot;, claims.get());</span>
<span class="fc" id="L234">			response.setClaims(new HashMap&lt;&gt;(claims.get()));</span>
<span class="fc" id="L235">			return Optional.of(response);</span>
<span class="fc" id="L236">		} catch (HttpClientErrorException e) {</span>
<span class="fc" id="L237">			log.error(&quot;getAccessToken, error while retrieving access token for {}: {}&quot;, login,</span>
<span class="fc" id="L238">					+e.getStatusCode().value());</span>
<span class="fc" id="L239">			return Optional.empty();</span>
		}
	}

	/**
	 * Gives the header for a basic authentication based on the client id and client
	 * secret. The final header is generated only once and then reused.
	 * 
	 * @return The basic authentication header.
	 */
	private String basicAuthentication() {
<span class="fc bfc" id="L250" title="All 2 branches covered.">		if (basicAuthenticationHeader == null) {</span>

<span class="fc" id="L252">			log.trace(&quot;basicAuthentication generating authentication header. &quot;);</span>
<span class="fc" id="L253">			final String auth = clientId + &quot;:&quot; + clientSecret;</span>

<span class="fc" id="L255">			final byte[] encodedAuth = Base64.getEncoder().encode(auth.getBytes(StandardCharsets.US_ASCII));</span>
<span class="fc" id="L256">			basicAuthenticationHeader = &quot;Basic &quot; + new String(encodedAuth);</span>
		}
<span class="fc" id="L258">		log.trace(&quot;basicAuthentication, basicAuthenticationHeader: {}&quot;, basicAuthenticationHeader);</span>
<span class="fc" id="L259">		return basicAuthenticationHeader;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>