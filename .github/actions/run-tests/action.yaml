name: "Run Tests"
description: "Compiles and runs Spring tests"

runs:
  using: "composite"
  steps:
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
            distribution: 'temurin'
            java-version: '21'
    
    - name: Add avenirs-apache to /etc/hosts
      run: |
        echo "127.0.0.1 avenirs-apache" | sudo tee -a /etc/hosts
      shell: bash
            
    - name: Generate env.properties to Ignore SSL Verification
      run: |
        echo "spring.security.oauth2.client.registration.custom-client-provider.provider.ssl-verification=false" > src/main/resources/env.properties
        echo "spring.ssl.ignore=true" >> src/main/resources/env.properties
        echo "spring.cloud.openfeign.ssl.skip-ssl-validation=true" >> src/main/resources/env.properties
        echo "server.ssl.enabled=false" >> src/main/resources/env.properties
      shell: bash

    - name: Wait for CAS to be ready
      run: |
        echo "Waiting for CAS to be ready..."
        for i in {1..10}; do
          STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://avenirs-apache/cas/login)
          if [ "$STATUS" -eq 200 ]; then
            echo "CAS is ready."
            break
          fi
          echo "CAS is not ready yet... retrying in 5 seconds. Current status: $STATUS"
          sleep 5
        done
      shell: bash

    - name: Build and Test
      run: |
         export MAVEN_OPTS="-Djavax.net.ssl.trustStore=$GITHUB_WORKSPACE/.github/cas/thekeystore.jks -Djavax.net.ssl.trustStorePassword=${{ secrets.KEYSTORE_PASSWORD }}"
         ./mvnw clean compile javadoc:javadoc test jacoco:report
      shell: bash 
