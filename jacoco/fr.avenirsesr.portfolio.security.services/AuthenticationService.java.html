<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">avenirs-portfolio-security</a> &gt; <a href="index.source.html" class="el_package">fr.avenirsesr.portfolio.security.services</a> &gt; <span class="el_source">AuthenticationService.java</span></div><h1>AuthenticationService.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package fr.avenirsesr.portfolio.security.services;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.HashMap;
import java.util.Optional;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestClient;

import fr.avenirsesr.portfolio.security.models.OIDCAccessTokenResponse;
import fr.avenirsesr.portfolio.security.models.OIDCIntrospectResponse;
import fr.avenirsesr.portfolio.security.models.OIDCProfileResponse;
import io.jsonwebtoken.Claims;

/**
 * &lt;h1&gt;AuthenticationService&lt;/h1&gt;
 * &lt;p&gt;
 * &lt;b&gt;Description:&lt;/b&gt; Interacts with OIDC Provider to retrieve or check access token (JWT)
 * &lt;/p&gt;
 *
 * &lt;h2&gt;Version:&lt;/h2&gt;
 * 1.0.0
 *
 * &lt;h2&gt;Author:&lt;/h2&gt;
 * Arnaud Deman
 *
 * &lt;h2&gt;Since:&lt;/h2&gt;
 * 04/10/2024
 */
<span class="fc" id="L40">@Slf4j</span>
@Service
<span class="fc" id="L42">public class AuthenticationService {</span>
	
	/** Rest client to interact with OIDC provider. */
<span class="fc" id="L45">	private final RestClient restClient = RestClient.create();</span>

	/** Template to generate the OIDC authorization URL. */
	@Value(&quot;${avenirs.authentication.oidc.authorise.template.url}&quot;)
	private String oidcAuthorizeTemplate;

	/** Template to generate the Access Token URL. */
	@Value(&quot;${avenirs.authentication.oidc.token.template.url}&quot;)
	private String oidcAccessTokenTemplate;

	@Value(&quot;${avenirs.authentication.oidc.provider.introspect.url}&quot;)
	private String oidcProviderIntrospectURL;

	/** Template to generate the service URL. */
	@Value(&quot;${avenirs.authentication.service.template}&quot;)
	private String serviceTemplate;

	/** Basic authentication header for the interaction with the OIDC provider. */
	private String basicAuthenticationHeader;

	/** Profile end point. */
	@Value(&quot;${avenirs.authentication.oidc.provider.profile.url}&quot;)
	private String oidcProviderProfileURL;

	@Value(&quot;${avenirs.authentication.oidc.client.id}&quot;)
	private String clientId;

	@Value(&quot;${avenirs.authentication.oidc.client.secret}&quot;)
	private String clientSecret;

	@Autowired
	private JWTService jwtService;

	/**
	 * Generates the OIDC Authorize URL.
	 * 
	 * @param host The host associated to the OIDC provider.
	 * @param code The code provided by the OIDC provider.
	 * @return The authorize URL.
	 */
	public String generateAuthorizeURL(String host, String code) {

<span class="nc" id="L87">		String oidcAuthorizeURL = oidcAuthorizeTemplate.replaceAll(&quot;%HOST%&quot;, host).replaceAll(&quot;%CODE%&quot;, code)</span>
<span class="nc" id="L88">				.replaceAll(&quot;%CLIENT_ID%&quot;, clientId).replaceAll(&quot;%CLIENT_SECRET%&quot;, clientSecret);</span>
<span class="nc" id="L89">		log.debug(&quot;generateAuthorizeURL, code: {}&quot;, code);</span>
<span class="nc" id="L90">		log.debug(&quot;generateAuthorizeURL, oidcAuthorizeURL: {}&quot;, oidcAuthorizeURL);</span>
<span class="nc" id="L91">		return oidcAuthorizeURL;</span>
	}

	/**
	 * Generates the OIDC Access Token URL.
	 * 
	 * @param login    The user login.
	 * @param password The user password.
	 * @return The authorize URL.
	  */
	protected String generateAccessTokenURL(String login, String password) {
<span class="fc" id="L102">		String oidcAccessTokenURL = oidcAccessTokenTemplate.replaceAll(&quot;%CLIENT_ID%&quot;, clientId)</span>
<span class="fc" id="L103">				.replaceAll(&quot;%CLIENT_SECRET%&quot;, clientSecret).replaceAll(&quot;%LOGIN%&quot;, login)</span>
<span class="fc" id="L104">				.replaceAll(&quot;%PASSWORD%&quot;, password);</span>
<span class="fc" id="L105">		log.debug(&quot;generateAccessTokenURL, oidcAccessTokenURL: {}&quot;, oidcAccessTokenURL);</span>
<span class="fc" id="L106">		return oidcAccessTokenURL;</span>
	}

	/**
	 * Generates the OIDC Authorize URL.
	 * 
	 * @param host The host associated to the OIDC provider.
	 * @return The service URL.
	  */
	public String generateServiceURL(String host) {

<span class="nc" id="L117">		String serviceURL = serviceTemplate.replaceAll(&quot;%HOST%&quot;, host);</span>
<span class="nc" id="L118">		log.debug(&quot;generateServiceURL, serviceURL: {}&quot;, serviceURL);</span>
<span class="nc" id="L119">		return serviceURL;</span>
	}

	/**
	 * Generates the OIDC Profile URL.
	 * 
	 * @param token The access token used to retrieve the user profile.
	 * @return The profile URL
	 */
	public String generateProfileURL(String token) {

<span class="nc" id="L130">		String profileURL = oidcProviderProfileURL + &quot;?token=&quot; + token;</span>
<span class="nc" id="L131">		log.debug(&quot;generateProfileURL, profileURL: {}&quot;, profileURL);</span>
<span class="nc" id="L132">		return profileURL;</span>
	}

	/**
	 * Generates the OIDC Introspect URL.
	 * 
	 * @param token The access token used to retrieve the user profile.
	 * @return The introspect URL
	 */
	public String generateIntrospectURL(String token) {

<span class="fc" id="L143">		String introspectURL = oidcProviderIntrospectURL + &quot;?token=&quot; + token;</span>
<span class="fc" id="L144">		log.trace(&quot;generateIntrospectURL, introspectURL: {}&quot;, introspectURL);</span>
<span class="fc" id="L145">		return introspectURL;</span>
	}

	/**
	 * Access token introspection end point.
	 * 
	 * @param token The token to introspect.
	 * @return The Profile response of the OIDC Provider.
	 */
	public OIDCProfileResponse profile(@RequestHeader(value = &quot;x-authorization&quot;) String token) {

<span class="nc" id="L156">		log.trace(&quot;profile&quot;);</span>

<span class="nc" id="L158">		OIDCProfileResponse profileResponse = restClient.post().uri(generateProfileURL(token))</span>
<span class="nc" id="L159">				.header(&quot;Authorization&quot;, basicAuthentication()).contentType(MediaType.APPLICATION_FORM_URLENCODED)</span>
<span class="nc" id="L160">				.accept(MediaType.APPLICATION_JSON).retrieve().body(OIDCProfileResponse.class);</span>

<span class="nc" id="L162">		log.warn(&quot;profile, profileResponse: {}&quot;, profileResponse);</span>

<span class="nc" id="L164">		return profileResponse;</span>
	}

	/**
	 * OIDC introspection of an access token.
	 * 
	 * @param token The access token to introspect.
	 * @return The introspect response of the OIDC Provider.
	 */
	public OIDCIntrospectResponse introspectAccessToken(String token) {

<span class="fc" id="L175">		log.debug(&quot;introspectAccessToken&quot;);</span>

<span class="fc" id="L177">		OIDCIntrospectResponse introspectResponse = restClient.post().uri(generateIntrospectURL(token))</span>
<span class="fc" id="L178">				.header(&quot;Authorization&quot;, basicAuthentication()).contentType(MediaType.APPLICATION_FORM_URLENCODED)</span>
<span class="fc" id="L179">				.accept(MediaType.APPLICATION_JSON).retrieve().body(OIDCIntrospectResponse.class);</span>

<span class="fc" id="L181">		log.debug(&quot;introspect, introspectResponse: {}&quot;, introspectResponse);</span>

<span class="fc" id="L183">		return introspectResponse;</span>
	}

	/**
	 * Generates an access token
	 * 
	 * @param login    The user login.
	 * @param password The user password.
	 * @return An Optional of OIDCAccessTokenResponse
	 */
	public Optional&lt;OIDCAccessTokenResponse&gt; getAccessToken(String login, String password) {
		try {

<span class="fc" id="L196">			String query = generateAccessTokenURL(login, password);</span>
<span class="fc" id="L197">			OIDCAccessTokenResponse response = restClient.post().uri(query).retrieve()</span>
<span class="fc" id="L198">					.body(OIDCAccessTokenResponse.class);</span>

<span class="pc bpc" id="L200" title="1 of 2 branches missed.">			if (response == null) {</span>
<span class="nc" id="L201">				return Optional.empty();</span>
			}

<span class="fc" id="L204">			final Optional&lt;Claims&gt; claims = this.jwtService.parseAndCheckSignature(response);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">			if (claims.isEmpty()) {</span>
<span class="nc" id="L206">				log.error(&quot;Invalid access token response: {}&quot;, response);</span>
<span class="nc" id="L207">				return Optional.empty();</span>
			}
			
<span class="fc" id="L210">			log.trace(&quot;Claims: {}&quot;, claims.get());</span>
<span class="fc" id="L211">			response.setClaims(new HashMap&lt;&gt;(claims.get()));</span>
<span class="fc" id="L212">			return Optional.of(response);</span>
<span class="nc" id="L213">		} catch (HttpClientErrorException e) {</span>
<span class="nc" id="L214">			log.error(&quot;getAccessToken, error while retrieving access token for {}: {}&quot;, login,</span>
<span class="nc" id="L215">					+e.getStatusCode().value());</span>
<span class="nc" id="L216">			return Optional.empty();</span>
		}
	}

	/**
	 * Gives the header for a basic authentication based on the client id and client
	 * secret. The final header is generated only once and then reused.
	 * 
	 * @return The basic authentication header.
	 */
	public String basicAuthentication() {
<span class="fc bfc" id="L227" title="All 2 branches covered.">		if (basicAuthenticationHeader == null) {</span>

<span class="fc" id="L229">			log.trace(&quot;basicAuthentication generating authentication header. &quot;);</span>
<span class="fc" id="L230">			final String auth = clientId + &quot;:&quot; + clientSecret;</span>

<span class="fc" id="L232">			final byte[] encodedAuth = Base64.getEncoder().encode(auth.getBytes(StandardCharsets.US_ASCII));</span>
<span class="fc" id="L233">			basicAuthenticationHeader = &quot;Basic &quot; + new String(encodedAuth);</span>
		}
<span class="fc" id="L235">		log.trace(&quot;basicAuthentication, basicAuthenticationHeader: {}&quot;, basicAuthenticationHeader);</span>
<span class="fc" id="L236">		return basicAuthenticationHeader;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>